services:
  backend:
    image: eclipse-temurin:21-jre
    container_name: aisocial-backend
    ports:
      - "11031:20030"
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:mysql://${MYSQL_HOST:-127.0.0.1}:${MYSQL_PORT:-3308}/${MYSQL_DB:-aisocialgame}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-aisocialgame}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-aisocialgame_pwd}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATA_REDIS_HOST: ${SPRING_DATA_REDIS_HOST:-127.0.0.1}
      SPRING_DATA_REDIS_PORT: ${SPRING_DATA_REDIS_PORT:-6381}
      APP_REDIS_TOKEN_KEY_PREFIX: ${APP_REDIS_TOKEN_KEY_PREFIX:-aisocialgame:auth:token:}
      APP_AUTH_TOKEN_TTL_HOURS: 168
      APP_PROJECT_KEY: ${APP_PROJECT_KEY:-aisocialgame}
      APP_AI_SYSTEM_USER_ID: ${APP_AI_SYSTEM_USER_ID:-1}
      APP_ADMIN_USERNAME: ${APP_ADMIN_USERNAME:-admin}
      APP_ADMIN_PASSWORD: ${APP_ADMIN_PASSWORD:-admin123}
      CONSUL_HTTP_ADDR: ${CONSUL_HTTP_ADDR:-http://127.0.0.1:8502}
      USER_GRPC_ADDR: ${USER_GRPC_ADDR:-consul:///aienie-userservice-grpc}
      BILLING_GRPC_ADDR: ${BILLING_GRPC_ADDR:-consul:///aienie-payservice-grpc}
      AI_GRPC_ADDR: ${AI_GRPC_ADDR:-consul:///aienie-aiservice-grpc}
      QDRANT_HOST: ${QDRANT_HOST:-http://127.0.0.1}
      QDRANT_PORT: ${QDRANT_PORT:-6335}
      QDRANT_ENABLED: ${QDRANT_ENABLED:-true}
      SSO_CALLBACK_URL: ${SSO_CALLBACK_URL:-http://aisocialgame.seekerhut.com/sso/callback}
      SERVER_PORT: ${SERVER_PORT:-20030}
      JAVA_OPTS: ""
      SPRING_CONFIG_ADDITIONAL_LOCATION: /app/config/
    working_dir: /app
    command: ["sh", "-c", "java ${JAVA_OPTS} -jar /app/app.jar"]
    volumes:
      - ./backend/target/ai-social-game-0.0.1-SNAPSHOT.jar:/app/app.jar:ro
      - ./backend/src/main/resources/application.yml:/app/config/application.yml:ro
      - ./backend/src/main/resources/prompt.yml:/app/config/prompt.yml:ro
    networks:
      - aisocial

  frontend:
    image: nginx:1.27-alpine
    container_name: aisocial-frontend
    depends_on:
      - backend
    ports:
      - "11030:80"
    volumes:
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - aisocial

networks:
  aisocial:
    driver: bridge
