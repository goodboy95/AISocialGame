# AI 社交游戏平台开发方案 — 步骤三：谁是卧底游戏引擎与 AI 接入

## 1. 目标概述
在房间与实时通信稳定后，实现“谁是卧底”游戏的完整状态机、词库管理与 AI 玩家自动补位能力。该阶段交付首个可运行的游戏模式，支持真人与 AI 混合参与，涵盖回合控制、发言、投票与胜负判定。

## 2. 范围与成果物
- 通用 `BaseGameEngine` 抽象与“谁是卧底”子类实现。
- 词库管理接口、卧底词/平民词分配逻辑。
- 游戏状态机：准备、发言、投票、结果公示等阶段控制。
- AI 玩家服务：支持自动补齐空位、根据风格生成发言与投票。
- 前端房间页升级为游戏面板：展示私密词语、阶段提示、计时器与投票 UI。

## 3. 详细任务拆分
### 3.1 游戏引擎基础
1. 在 `apps/gamecore` 中定义 `BaseGameEngine`：
   - 接口：`start_game(room)`、`handle_event(event)`、`serialize_state()`。
   - 管理通用回合信息（当前轮次、阶段、计时器、存活玩家）。
2. 在 `apps/games/undercover` 中实现 `UndercoverEngine`：
   - 初始化：根据房间配置确定卧底人数、白板数量（可选）。
   - 状态机：`preparing -> speaking -> voting -> result -> end`。
   - 事件处理：玩家发言完成、发言超时、投票结果统计、平票重投。
3. 游戏服务与房间集成：
   - 房间 `start` 接口调用引擎 `start_game`，并通过 Channels 将阶段事件推送给前端。
   - 在 `RoomPlayer` 中存储词语、是否为卧底、是否存活。

### 3.2 词库与配置管理
1. 建立词库模型/管理：
   - `WordPair`：包含 `civilian_word`, `undercover_word`, `topic`, `difficulty`。
   - 后台管理页面或简单 REST 接口用于增删改查（可在后续管理端完善）。
2. 游戏启动时从词库随机抽取词对；若有白板玩家，提供空白词逻辑。
3. 支持通过房间配置指定词库类别或难度。

### 3.3 AI 玩家接入
1. 在房间 `start` 阶段，根据房间设置自动添加 AI 玩家，分配虚拟用户、头像、昵称。
2. 实现 AI 服务模块：
   - 封装调用 OpenAI 兼容接口的 Client，支持流式响应。
   - 设计提示词模板：包含角色身份、词语、当前阶段描述、历史发言与目标。
   - 风格系统：根据选择的风格（如“理性分析”“幽默调侃”）调整提示词。
3. 后端事件流：
   - 在发言阶段，轮到 AI 时触发消息生成，通过 Channels 流式推送给前端。
   - 在投票阶段，AI 返回投票目标，通过后端统一投票接口。
4. 错误处理与重试：
   - 设定 AI 超时时间、重试次数；若失败则使用兜底文案。

### 3.4 前端游戏面板
1. 重新设计房间页结构：
   - 顶部显示阶段、倒计时、当前发言人。
   - 左侧/中央展示聊天与发言流；支持 AI 流式文字。
   - 右侧显示玩家卡片：身份标识（仅本人可见）、存活状态。
2. 发言阶段：
   - 真人玩家显示输入框与提交按钮；AI 发言时显示加载状态。
3. 投票阶段：
   - 展示所有存活玩家，可点击投票；显示当前投票进度。
   - 投票完成后展示统计结果与被淘汰玩家。
4. 结果阶段：
   - 显示胜负信息、可选择继续下一轮或返回大厅。
5. 处理私密信息：仅向当前玩家展示自己的词语与身份。

### 3.5 测试与验证
1. 后端：
   - 单元测试覆盖状态机转移、词库分配、投票计票、AI 接口调用（mock）。
   - 集成测试模拟多玩家场景，验证 Channels 推送顺序与数据正确性。
2. 前端：
   - 编写组件测试，验证阶段切换 UI 行为。
   - 使用 e2e 测试脚本模拟完整一局流程（真人 + AI）。
3. 性能与稳定性：
   - 测试同时多房间进行游戏时的资源占用。
   - 监控 AI 调用延迟，记录失败率。

## 4. 关键技术点与实现建议
- **状态机实现**：可使用 `transitions` 库或手写状态图，确保易于扩展至狼人杀。
- **事件驱动**：通过 Channels 的 `group_send` 发送结构化事件（阶段更新、发言、投票结果），前端统一处理。
- **流式推送**：利用 Channels 的 `AsyncJsonWebsocketConsumer`，在 AI 发言时逐段推送，前端使用 `ReadableStream` 接收。
- **安全性**：确保仅当前发言者可提交发言；投票仅允许一次；防止私密词语泄露给其他玩家。
- **日志追踪**：记录每轮事件、AI 输出，用于调试和数据分析。

## 5. 验收标准
- 房主点击开始后自动补齐 AI，所有玩家获得词语与身份信息。
- 发言阶段按顺序轮转，AI 发言以流式形式呈现。
- 投票阶段统计正确，胜负判定符合规则，游戏可进入下一轮或结束。
- 前端 UI 响应及时，私密信息展示正确，未泄漏给其他玩家。
- 单元测试、集成测试通过，AI 接口调用稳定。

## 6. 里程碑与时间预估
- **第 5 周**：完成 BaseGameEngine 与 UndercoverEngine 核心逻辑、词库模块。
- **第 6 周上旬**：打通 AI 发言/投票流程，后端测试通过。
- **第 6 周中旬**：前端游戏面板联调完成，交付“谁是卧底”可玩版本。

> 步骤三交付首个完整游戏模式，后续可在此基础上拓展“狼人杀”与更多玩法。
