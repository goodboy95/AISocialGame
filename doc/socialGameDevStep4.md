# AI 社交游戏平台开发方案 — 步骤四：狼人杀引擎与高级实时交互

## 1. 目标概述
在“谁是卧底”模式稳定运行后，实现精简版“狼人杀”游戏，包括夜间角色行动、白天发言与投票，以及与 AI 的深度交互。重点解决私密频道、角色技能与多阶段状态机管理，进一步验证系统扩展性。

## 最新进展摘要
- ✅ `WerewolfEngine` 已完成并注册到统一引擎表，支持夜晚（狼人击杀、预言家查验、女巫解药/毒药）与白天（发言、投票、结算）多阶段流程，可根据房间配置自动选择玩法。
- ✅ `RoomPlayer` 新增 `has_used_skill` 字段，角色分配时写入，女巫/预言家使用技能后同步更新；`ENGINE_REGISTRY` 及 `rooms.services.start_room` 支持读取房间配置切换玩法。
- ✅ `apps/ai.services.WerewolfAIStrategy` 实现狼人杀夜间/白天启发式决策；`get_public_state` 针对不同玩家输出私密信息（狼人同伴、预言家查验记录、女巫药水余量）。
- ✅ 前端 `RoomPage` 根据引擎动态渲染两套面板：狼人阶段操作（击杀、查验、解药/毒药）与白天发言/投票、AI 行动提示，保持聊天/房间成员视图一致。
- ✅ 新增 `pytest` 用例覆盖完整一夜一昼流程，验证夜间技能优先级、白天投票淘汰与身份公开逻辑。

## 2. 范围与成果物
- 狼人杀角色配置与房间定制化参数。
- `WerewolfEngine` 状态机：夜晚行动、白天发言、投票、公示。
- 夜晚私密频道（狼人阵营、预言家视图、女巫操作面板）。
- AI 行动策略：夜间击杀/救人建议、白天发言、投票行为。
- 前端狼人杀专属面板与多视图呈现。

## 3. 详细任务拆分
### 3.1 角色与配置模型
1. 新增 `RoleConfig` 模型或在房间配置中定义角色数量（狼、民、预言家、女巫等）。
2. 游戏开始前根据房间人数和配置进行角色分配，将结果写入 `RoomPlayer`（字段：`role`, `is_alive`, `has_used_skill` 等）。
3. 支持房主在创建房间或开始前调整角色配置、夜间时长、发言顺序等参数。

### 3.2 WerewolfEngine 实现
1. 扩展 `BaseGameEngine` 支持多阶段状态机：
   - `night.assign_roles`（一次性）、`night.actions`、`day.discussion`、`day.vote`、`day.result`、`end`。
2. 夜间阶段：
   - 狼人私密频道商议并选择击杀目标。
   - 预言家查看玩家身份（一次每夜）。
   - 女巫可救或毒（配置是否一次性）。
3. 白天阶段：
   - 系统广播夜间结果（死亡名单）。
   - 轮流发言或自由发言模式（根据配置）。
   - 投票淘汰流程，处理平票（可再投或进入 PK）。
4. 胜负判定：根据狼人与村民阵营人数判断是否结束。
5. 事件与消息：为每个阶段定义 WebSocket 事件，含私密 payload。

### 3.3 私密通信与权限控制
1. 所有玩法仍复用 `room_{id}` WebSocket 分组，私密信息通过 `engine.get_public_state(for_user=...)` 动态裁剪，避免额外频道负担。
2. 狼人阵营在公共状态中仅能看到自身及同伴信息；预言家、女巫的查验/药水余量在 `private` 字段返回，仅对应玩家可见。
3. 所有夜间技能通过 `game.event` 统一上送（`submit_wolf_target`、`submit_seer_target`、`submit_witch_action`），Consumer 复用原有权限校验逻辑。

### 3.4 AI 策略与提示词
1. 为不同角色设计提示词模板与策略：
   - 狼人：夜间击杀目标选择逻辑（基于当前局势、历史发言）。
   - 预言家/女巫：行动建议与决策描述。
   - 平民：白天发言与投票策略。
2. 在夜间私密频道中允许 AI 生成多轮对话或决策理由。
3. 设计数据结构缓存历史事件，供 AI 参考（如投票记录、身份推测）。
4. 设置安全限制：避免 AI 直接透露真实身份（除特殊场景）。

### 3.5 前端狼人杀面板
1. 依据角色显示不同 UI：
   - 夜间阶段：
     - 狼人看到私密讨论窗口与目标选择界面。
     - 预言家、女巫看到技能按钮及倒计时。
   - 白天阶段：发言列表、计时器、投票 UI。
2. 实现多阶段状态指引、动画反馈（如昼夜切换）。
3. 聊天系统保持公聊逻辑，私密信息由面板内提示展示（无额外频道切换）。
4. 展示玩家身份信息（仅在游戏结束或死亡后公开），维护公正性。

### 3.6 测试与验证
1. 后端：
   - 单元测试覆盖角色技能逻辑、胜负判定、事件广播。
   - 模拟夜间多角色同时行动，验证冲突处理（如女巫救/毒与狼人击杀顺序）。
2. 前端：
   - 组件测试验证不同角色视图的权限与 UI 行为。
   - e2e 测试覆盖完整一局（含 AI 玩家），检查状态同步。
3. 负载测试：
   - 测试多个房间同时进行狼人杀时 Channels 与 AI 调用的压力。

## 4. 关键技术点与实现建议
- **复杂状态管理**：使用事件队列或调度器控制夜间多角色先后顺序，确保流程清晰。
- **时间控制**：引入倒计时服务（后端或前端），超时自动执行默认操作（如未投票自动弃票）。
- **AI 透明度**：记录 AI 决策理由，在前端以合适形式展示（可选），提升可玩性。
- **可配置性**：将角色数量、胜利条件、技能冷却等设计为配置，方便未来扩展新角色。

## 5. 验收标准
- 游戏流程可从角色分配顺利进行到胜负判定，所有阶段事件正确广播。
- 私密频道权限准确，未授权用户无法接收到敏感信息。
- AI 玩家能参与夜间行动、发言与投票，其行为符合设定风格。
- 前端界面在昼夜切换、私密频道、技能使用等场景表现稳定。
- 自动化测试与压力测试通过，系统在并发场景下无明显故障。

## 6. 里程碑与时间预估
- **第 7 周**：完成角色配置、WerewolfEngine 状态机核心逻辑。
- **第 8 周上旬**：实现夜间私密频道与 AI 行为，后端测试通过。
- **第 8 周中旬**：前端狼人杀面板联调完成，验收步骤四。

> 步骤四完成后，平台具备两款核心游戏模式，可进入最终打磨、部署与运维阶段。
