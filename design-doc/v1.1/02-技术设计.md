# AISocialGame v1.1 技术设计

## 1. 设计目标
- 在不大幅破坏现有前端接口与页面路由的前提下，完成 user/pay/ai 微服务接入。
- 通过 BFF（当前 Spring Boot backend）统一封装外部 gRPC 细节，前端仍以 HTTP 调用。
- 新增管理后台，覆盖“运营可观测 + 用户/积分/AI 基础运维”能力。

## 2. 总体架构

```text
Frontend (Web + Admin)
        |
        | HTTP /api/*
        v
AISocialGame Backend (BFF, Spring Boot)
        |-- grpc(user)    -> user-service
        |-- grpc(billing) -> pay-service
        |-- grpc(ai)      -> ai-service
        |
        +-- Consul(service discovery, optional)
```

关键点：
- 前端不直接访问 gRPC 微服务。
- 后端对外保持稳定 REST；对内用 gRPC 调用并做 DTO 映射、错误统一和鉴权。

## 3. 与 fireflyChat 对齐的实现模式
- gRPC 客户端：采用 `@GrpcClient("user"|"billing"|"ai")` 注入 blocking stub。
- 服务发现：支持 `consul:///aienie-*-grpc` 与 `static://host:port` 双模式。
- Admin 前端：独立 `AdminAuthProvider`、`AdminLayout`、`/admin/*` 路由分区。

## 4. 后端改造设计

## 4.1 新增配置
- `backend/src/main/resources/application.yml` 增加：
  - `grpc.client.user.address`
  - `grpc.client.billing.address`
  - `grpc.client.ai.address`
  - `app.project-key`（用于 pay/ai 请求）
- 环境变量建议：
  - `CONSUL_HTTP_ADDR`（如 `192.168.1.4:60000`）
  - `USER_GRPC_ADDR` / `BILLING_GRPC_ADDR` / `AI_GRPC_ADDR`

## 4.2 gRPC 基础层
- 新增包建议：`backend/src/main/java/com/aisocialgame/integration/grpc/`
  - `client/UserGrpcClient.java`
  - `client/BillingGrpcClient.java`
  - `client/AiGrpcClient.java`
  - `dto/*`（内部映射 DTO）
  - `exception/GrpcMappingException.java`
- 新增 Consul 解析器（参考 fireflyChat）：
  - `integration/consul/ConsulNameResolverProvider.java`
  - `src/main/resources/META-INF/services/io.grpc.NameResolverProvider`

## 4.3 鉴权链路改造
- 保留 HTTP 接口路径：
  - `POST /api/auth/register`
  - `POST /api/auth/login`
  - `GET /api/auth/me`
- `AuthService` 迁移策略：
  - `register` -> `UserAuthService.RegisterUser`
  - `login` -> `UserAuthService.LoginUser`
  - `authenticate` -> 本地 token store 查到 `userId/sessionId` 后，再调 `ValidateSession`
- 本地 `users` 表保留为兼容缓存（可选），但不再作为密码来源。

## 4.4 积分聚合设计
- 新增服务：`BalanceService`
  - 调 `BillingBalanceService.GetPublicBalance(userId)`
  - 调 `BillingBalanceService.GetProjectBalance(projectKey, userId)`
  - 计算 `total = public + projectTemp + projectPermanent`
- 返回策略：
  - 方案 A：扩展 `/api/auth/me` 响应
  - 方案 B：新增 `/api/profile/balance`
- v1.1 建议：方案 A（前端改造最小）。

## 4.5 AI 调用改造
- 现有本地 AI 调用点统一切换到 `AiGatewayService.ChatCompletions`。
- 新增模型查询接口：
  - `GET /api/ai/models` -> `ListModels`
- 聊天/推理接口（可复用现有路径）：
  - `POST /api/ai/chat` -> `ChatCompletions`
  - 请求透传 `projectKey/userId/sessionId/messages`

## 4.6 后台管理 API 设计（新增）
- `POST /api/admin/auth/login`
- `GET /api/admin/auth/me`
- `GET /api/admin/dashboard/summary`
- `GET /api/admin/integration/services`
- `GET /api/admin/users`
- `POST /api/admin/users/{userId}/ban`
- `POST /api/admin/users/{userId}/unban`
- `GET /api/admin/billing/balance`
- `GET /api/admin/billing/logs`
- `GET /api/admin/ai/models`
- `POST /api/admin/ai/test-chat`

说明：
- 管理端接口由 AISocialGame backend 聚合，不直接暴露微服务账号体系到前端。

## 5. 前端改造设计

## 5.1 用户态（现有前台）
- `useAuth.tsx`
  - 注册/登录后保存新 token；
  - `me()` 响应增加余额字段时同步更新 `user` 类型。
- `MainLayout.tsx`
  - 头部积分展示使用聚合余额字段（替代本地 coins）。
- `services/api.ts`
  - 新增 `aiApi`、`adminApi`（与现有 `authApi/gameApi` 并行）。

## 5.2 管理态（新增）
- 路由：
  - `/admin/login`
  - `/admin`
  - `/admin/users`
  - `/admin/billing`
  - `/admin/ai`
  - `/admin/integration`
- 组件建议：
  - `hooks/useAdminAuth.tsx`
  - `components/layout/AdminLayout.tsx`
  - `pages/admin/*.tsx`
- UI 原则：
  - 借鉴 fireflyChat 的“侧栏 + 卡片 + 图表”信息架构；
  - 业务内容换成 AISocialGame 的用户、积分、AI、服务联通性，不照搬原业务模块。

## 6. 数据与兼容策略
- `User.id` 当前为 `String(UUID)`，外部 user-service 使用 `int64 user_id`。
- 方案：
  - 新增字段映射（建议 `externalUserId`），内部主键暂不强制替换；
  - token store 以 `externalUserId + sessionId` 为鉴权核心。
- 兼容期：
  - 保留旧字段，避免一次性迁移带来的风险；
  - v1.2 再评估是否统一主键体系。

## 7. 异常与可观测
- gRPC 异常统一转换为业务错误码：
  - 认证失败 -> `401`
  - 参数问题 -> `400`
  - 上游不可用 -> `503`
- 日志要求：
  - 记录 `requestId`, `service`, `method`, `latency`, `result`
  - 脱敏 `password/token`

## 8. 测试设计

## 8.1 单元测试
- `AuthService`：
  - 注册成功/已存在/登录失败/会话失效
- `BalanceService`：
  - public/project 余额聚合
- `AiServiceAdapter`：
  - 请求映射、空响应与异常分支
- `AdminService`：
  - ban/unban、模型查询、聚合统计

## 8.2 集成测试
- gRPC stub + mock server 校验协议兼容。
- Consul 解析器在 `consul:///` 场景可返回实例。

## 8.3 E2E（Playwright）
- 前台：注册 -> 登录 -> 进入大厅 -> 查看积分 -> 发起 AI 交互
- 后台：登录 -> 查看仪表盘 -> 用户封禁/解封 -> 查看积分日志 -> AI 测试调用

## 9. 实施顺序建议
1. gRPC 基础设施与配置
2. 鉴权迁移（user-service）
3. 积分聚合（pay-service）
4. AI 调用迁移（ai-service）
5. 管理后台前后端
6. 全量测试与文档收尾
