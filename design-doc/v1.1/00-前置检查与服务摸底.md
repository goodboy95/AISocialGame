# v1.1 前置检查与服务摸底

## 1. 前置结论
- 检查时间：2026-02-16
- `grpcurl` 可用性：通过（`grpcurl -help` 正常返回）
- 结论：满足“可使用 grpcurl 才继续”的前置条件，可进入 v1.1 规划与开发阶段。

## 2. Consul 服务发现结果
- Consul 地址：`http://192.168.1.4:60000`
- 核验接口：
  - `GET /v1/catalog/services`
  - `GET /v1/agent/services`
  - `GET /ui/`（HTTP 200）

### 2.1 发现到的目标服务
- `aienie-userservice-grpc` -> `192.168.1.3:20002`
- `aienie-payservice-grpc` -> `192.168.1.3:20004`
- `aienie-aiservice-grpc` -> `192.168.1.3:20003`

## 3. gRPC 反射与健康检查

### 3.1 health 检查
- `192.168.1.3:20002`：`SERVING`
- `192.168.1.3:20003`：`SERVING`
- `192.168.1.3:20004`：`SERVING`

### 3.2 user-service（`192.168.1.3:20002`）
- `fireflychat.user.v1.EmailVerificationService`
  - `SendEmailCode`
  - `VerifyEmailCode`
- `fireflychat.user.v1.UserAuthService`
  - `RegisterUser`
  - `LoginUser`
  - `ResetPassword`
  - `ValidateSession`
- `fireflychat.user.v1.UserBanService`
  - `BanUser`
  - `GetBanStatus`
  - `UnbanUser`
- `fireflychat.user.v1.UserDirectoryService`
  - `BatchGetUserBasic`
  - `GetUserBasic`
- `fireflychat.user.v1.UserPreferenceService`
  - `GetProjectPreferences`
  - `UpsertProjectPreferences`

### 3.3 ai-service（`192.168.1.3:20003`）
- `fireflychat.ai.v1.AiGatewayService`
  - `ChatCompletions`
  - `Embeddings`
  - `ListModels`

### 3.4 pay-service（`192.168.1.3:20004`）
- `fireflychat.billing.v1.BillingBalanceService`
  - `GetProjectBalance`
  - `GetPublicBalance`
- `fireflychat.billing.v1.BillingCheckinService`
  - `Checkin`
  - `GetCheckinStatus`
- `fireflychat.billing.v1.BillingConversionService`
  - `ConvertPublicToProject`
- `fireflychat.billing.v1.BillingGrantService`
  - `GrantProjectPermanentTokens`
  - `GrantPublicTokens`
- `fireflychat.billing.v1.BillingOnboardingService`
  - `EnsureUserInitialized`
- `fireflychat.billing.v1.BillingProjectModelQuotaService`
  - `CheckAndConsumeQuota`
- `fireflychat.billing.v1.BillingQueryService`
  - `ListLedgerEntries`
  - `ListUsageRecords`
- `fireflychat.billing.v1.BillingRedeemCodeService`
  - `GetRedemptionHistory`
  - `RedeemCode`
- `fireflychat.billing.v1.BillingUsageService`
  - `DeductPerCall`
  - `DeductUsage`

## 4. v1.1 关键对接字段（反射得到）

### 4.1 用户注册/登录
- `RegisterUserRequest`
  - `request_id`, `username`, `email`, `password`, `display_name`, `avatar_url`, `ip_address`, `user_agent`
- `LoginUserRequest`
  - `request_id`, `username`, `password`, `ip_address`, `user_agent`
- `RegisterUserResponse` / `LoginUserResponse`
  - `success`, `error_message`, `user`, `access_token`, `session_id`
- `ValidateSessionRequest`
  - `user_id`, `session_id`
- `ValidateSessionResponse`
  - `valid`, `user`

### 4.2 积分展示
- `GetProjectBalanceRequest`
  - `project_key`, `user_id`
- `GetProjectBalanceResponse`
  - `balance(ProjectBalance)`
- `ProjectBalance`
  - `temp_tokens`, `temp_expires_at`, `permanent_tokens`
- `GetPublicBalanceResponse`
  - `public_permanent_tokens`

### 4.3 AI 调用
- `ChatCompletionsRequest`
  - `request_id`, `project_key`, `user_id`, `session_id`, `model`, `messages[]`
- `ChatMessage`
  - `role`, `content`
- `ChatCompletionsResponse`
  - `content`, `model_key`, `prompt_tokens`, `completion_tokens`
- `ListModelsResponse`
  - `models[]`

## 5. 可复用探测命令（已验证）
```bash
grpcurl -plaintext 192.168.1.3:20002 list
grpcurl -plaintext 192.168.1.3:20003 list
grpcurl -plaintext 192.168.1.3:20004 list

grpcurl -plaintext -d '{"service":""}' 192.168.1.3:20002 grpc.health.v1.Health/Check
grpcurl -plaintext -d '{"service":""}' 192.168.1.3:20003 grpc.health.v1.Health/Check
grpcurl -plaintext -d '{"service":""}' 192.168.1.3:20004 grpc.health.v1.Health/Check
```

## 6. 当前结论
- Consul 与三类微服务均可访问，且 reflection 可用。
- v1.1 的 user/pay/ai 三条对接链路具备开发前提。
