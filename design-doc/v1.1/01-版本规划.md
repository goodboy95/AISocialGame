# AISocialGame v1.1 版本规划

## 1. 版本目标
基于现有 AISocialGame（本地账号/本地金币/本地 AI 调用）升级为微服务对接版本，完成以下四项核心能力：
- 对接 `user-service`，实现注册/登录/会话校验。
- 对接 `pay-service`，实现积分余额展示（公共余额 + 项目余额）。
- 对接 `ai-service`，统一走 AI 网关接口。
- 新增后台管理界面（风格参考 fireflyChat，但功能聚焦 AISocialGame 业务）。

## 2. 范围定义

### 2.1 本次包含
- 后端：新增 gRPC 客户端层、服务发现能力、鉴权改造、积分查询聚合、AI 调用适配、后台管理 API。
- 前端：登录注册流程适配、主导航积分展示改造、AI 交互请求改造、后台管理页面与路由。
- 文档：`design-doc`、`doc/structure.md`、`doc/api/*`、`doc/modules/*`、测试文档同步。
- 测试：新增单元测试 + 必要集成测试项 + Playwright 回归路径。

### 2.2 本次不包含
- 不改动 user/pay/ai 三个外部微服务的实现。
- 不做支付充值链路（只做余额展示与已有接口消费）。
- 不做复杂运维系统，仅提供项目内后台管理。

## 3. 参考基线（fireflyChat 可复用模式）
- gRPC 接入：`@GrpcClient` + 多服务 client 配置。
- Consul 发现：自定义 `consul:///service-name` 的 NameResolver。
- 前端管理后台：独立 `/admin/*` 路由 + 专用鉴权上下文 + 侧边栏布局。

## 4. 里程碑拆解

## M1：基础设施与连通性（优先级 P0）
- 在 backend 引入 gRPC 依赖与 proto 生成流程（或引入已生成 stub 模块）。
- 增加 Consul 解析能力（默认 `CONSUL_HTTP_ADDR`）。
- 配置 `grpc.client.user/pay/ai` 地址（支持 `static://` 与 `consul:///` 两种模式）。
- 产出健康检查与自检端点（可选 `/api/admin/integration/health`）。

验收标准：
- 本地/测试环境可通过业务代码成功调用 `user/pay/ai` 的最小接口（如 `ValidateSession`、`GetProjectBalance`、`ListModels`）。

## M2：用户体系对接（P0）
- 改造 `AuthService`：由本地密码校验切换到 `user-service` 的 `RegisterUser/LoginUser/ValidateSession`。
- token 方案调整：
  - 前端仍透传 `X-Auth-Token`；
  - 后端将 token 存储结构改为“映射远端 `userId + sessionId + accessToken`”。
- `AuthController` 保持现有 `/api/auth/register|login|me` 路径，减少前端改造面。

验收标准：
- 注册、登录、`/me` 能使用 user-service 数据返回；
- 无本地用户密码依赖。

## M3：积分展示与 AI 接口切换（P0）
- 积分：
  - 在 `/api/auth/me` 或新增 `/api/profile/balance` 中聚合 pay-service 的 `GetPublicBalance + GetProjectBalance`。
  - 前端头部积分卡显示真实聚合余额。
- AI：
  - 将当前 AI 逻辑统一切到 `AiGatewayService.ChatCompletions`；
  - 保留模型列表拉取能力（`ListModels`），供后续配置或前端选择。

验收标准：
- 登录后可看到真实余额；
- 游戏内 AI 对话链路改为 ai-service 提供。

## M4：后台管理界面（P1）
- 新增管理端登录与鉴权（与前台鉴权隔离，token key 独立）。
- 后台页面建议最小闭环：
  - 仪表盘：服务状态、调用概览、错误提示。
  - 用户管理：查询用户、查看封禁状态、执行封禁/解封（调用 `UserBanService`）。
  - 积分管理：查看用户余额、积分流水（调用 `BillingQueryService/BillingBalanceService`）。
  - AI 网关管理：模型列表、测试调用（调用 `AiGatewayService`）。
  - 系统设置：项目 key、服务发现模式、连通性检查。

验收标准：
- `/admin/login` 与 `/admin` 可访问；
- 管理后台核心动作可真实调用微服务。

## M5：测试与发布收尾（P0）
- 单元测试：Auth/Balance/AI 客户端映射与异常分支。
- 集成测试：三服务连通、关键业务路径。
- Playwright：前台注册登录、积分显示、AI 交互、后台登录与核心功能。
- 文档补齐与 `build.sh`、`docker-compose.yml` 流程复核。

## 5. 风险与应对
- 风险：微服务 proto 变更导致编译失败。
  - 应对：将 proto 与版本锁定，生成代码纳入构建流程。
- 风险：Consul 地址/策略变化导致发现失败。
  - 应对：保留 `static://` 回退模式，启动时打印当前解析结果。
- 风险：远端接口错误码语义与当前前端提示不一致。
  - 应对：在 BFF 层统一错误码映射与文案。
- 风险：后台权限模型不完整。
  - 应对：先做最小 RBAC（ADMIN），后续版本再细化。

## 6. 交付物清单
- 设计文档：`design-doc/v1.1/00-前置检查与服务摸底.md`、`design-doc/v1.1/01-版本规划.md`、`design-doc/v1.1/02-技术设计.md`
- 代码改造：backend + frontend
- 文档同步：`doc/structure.md`、`doc/api/*`、`doc/modules/*`、`doc/test/*`
- 测试记录：Playwright 结果与问题清单（如有阻塞写入 `doc/issues.md`）
