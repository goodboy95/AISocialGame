# AISocialGame v1.2 版本规划

## 1. 版本目标

在 v1.1 完成三服务 gRPC 基础对接的基础上，v1.2 聚焦三个方向：

1. **SSO 统一认证**：移除本地登录/注册表单，切换到 user-service 提供的 SSO 页面，实现统一账号体系。
2. **AI 能力扩展**：在现有 ChatCompletions 基础上，新增 Embeddings（向量生成）和 OCR（文档解析）能力，并为 Chat 接口增加 SSE 流式输出。
3. **积分体系完善**：新增每日签到、积分消费记录、账本明细、兑换码兑换功能，作为个人中心的子页面呈现。

## 2. 范围定义

### 2.1 本次包含

**后端：**
- SSO 跳转 URL 生成（从 Consul 动态获取 user-service HTTP 地址）
- SSO 回调认证（解析 SSO 回传的 access_token/user_id/session_id，建立本地会话）
- AI Embeddings / OCR 接口代理
- AI Chat SSE 流式输出（后端 gRPC Unary → SSE 分块推送）
- 签到接口（Checkin / GetCheckinStatus）
- 消费记录与账本查询（ListUsageRecords / ListLedgerEntries）
- 兑换码兑换（RedeemCode / GetRedemptionHistory）

**前端：**
- 移除 Login.tsx / Register.tsx，替换为 SSO 跳转流程
- 新增 SSO 回调页面（解析 URL fragment，调用后端建立会话）
- AI 聊天界面支持 SSE 流式渲染
- 个人中心新增「我的钱包」子页面（签到、余额明细、消费记录、兑换码）

**文档与测试：**
- design-doc/v1.2 设计文档
- doc/api/* 接口文档同步
- 单元测试补齐
- Playwright E2E 路径更新

### 2.2 本次不包含

- 不改动 user/pay/ai 三个外部微服务的实现。
- 不做充值/支付链路。
- 不做公共余额转项目余额（ConvertPublicToProject）的用户侧操作。
- 不做 AI 流式的 gRPC Server Streaming（ai-service 当前为 Unary，流式效果由后端模拟分块）。

## 3. 里程碑拆解

### M1：SSO 统一认证（P0）

- 后端：
  - 新增 Consul HTTP 服务发现能力（查询 `aienie-userservice-http` 获取地址）
  - 新增 `GET /api/auth/sso-url` 接口，返回 SSO 登录/注册页面 URL
  - 新增 `POST /api/auth/sso-callback` 接口，接收 SSO 回传数据并建立本地会话
  - 移除 `POST /api/auth/login` 和 `POST /api/auth/register` 接口
- 前端：
  - 删除 Login.tsx / Register.tsx
  - 新增 SsoCallback.tsx 页面（路由 `/sso/callback`）
  - useAuth 改造：登录流程改为跳转 SSO → 回调解析 → 建立会话
  - 所有「登录」入口改为调用 SSO 跳转

验收标准：
- 点击登录 → 跳转 user-service SSO 页面 → 完成登录/注册 → 回跳到本站 → 自动建立会话
- `/api/auth/me` 正常返回用户信息与余额

### M2：AI 能力扩展（P1）

- 后端：
  - AiProxyService 新增 `embeddings()` 方法，代理 `AiGatewayService.Embeddings`
  - AiProxyService 新增 `ocrParse()` 方法，代理 `AiGatewayService.OcrParse`
  - AiController 新增 `POST /api/ai/embeddings` 和 `POST /api/ai/ocr`
  - AiController 新增 `POST /api/ai/chat/stream`，返回 `text/event-stream`
  - SSE 实现：gRPC Unary 调用完成后，将响应内容按字符/词分块通过 SSE 推送
- 前端：
  - aiApi 新增 embeddings / ocr / chatStream 方法
  - AI 聊天组件支持 SSE 流式渲染（逐字显示效果）

验收标准：
- `/api/ai/embeddings` 可返回向量结果
- `/api/ai/ocr` 可返回解析文本
- `/api/ai/chat/stream` 以 SSE 逐块返回内容，前端逐字渲染

### M3：积分体系完善（P0）

- 后端：
  - BillingGrpcClient 新增签到、消费记录、账本、兑换码相关 gRPC 调用
  - 新增 WalletController（或扩展现有 Controller）：
    - `POST /api/wallet/checkin` — 每日签到
    - `GET /api/wallet/checkin-status` — 签到状态查询
    - `GET /api/wallet/balance` — 余额明细（公共+项目）
    - `GET /api/wallet/usage-records` — 消费记录分页
    - `GET /api/wallet/ledger` — 账本明细分页
    - `POST /api/wallet/redeem` — 兑换码兑换
    - `GET /api/wallet/redemption-history` — 兑换历史分页
- 前端：
  - 个人中心（Profile）新增「我的钱包」子页面/Tab
  - 钱包页面包含：签到卡片、余额概览、消费记录列表、兑换码输入框
  - 头部积分点击可跳转到钱包页面

验收标准：
- 签到成功后积分增加，重复签到提示已签到
- 消费记录和账本可分页查看
- 兑换码输入后积分到账

### M4：测试与文档收尾（P0）

- 单元测试：SSO 回调、签到、兑换码、AI 新接口
- E2E：SSO 登录流程、签到、查看消费记录、AI 流式聊天
- 文档同步：API 文档、模块文档、结构文档

## 4. 风险与应对

| 风险 | 应对 |
|---|---|
| user-service SSO 回跳白名单未配置 | 部署前确认 `sso.allowed-redirect-origins` 包含本站回调地址 |
| Consul HTTP 服务发现与 gRPC 发现逻辑不同 | 新增独立的 Consul HTTP 查询工具类，不复用 gRPC NameResolver |
| SSE 流式输出在 gRPC Unary 模式下体验有限 | 后端按字符分块模拟流式，后续 ai-service 支持 Streaming 后可无缝切换 |
| 签到/兑换码的幂等性 | 所有写操作传入稳定唯一 request_id |

## 5. 交付物清单

- 设计文档：`design-doc/v1.2/01-版本规划.md`、`design-doc/v1.2/02-技术设计.md`
- 代码改造：backend + frontend
- 文档同步：`doc/structure.md`、`doc/api/*`、`doc/modules/*`
- 测试记录：单元测试 + Playwright E2E
