# AISocialGame v1.2 æŠ€æœ¯è®¾è®¡

## 1. è®¾è®¡ç›®æ ‡

- SSO ç»Ÿä¸€è®¤è¯ï¼šç§»é™¤æœ¬åœ°ç™»å½•æ³¨å†Œï¼Œå…¨é¢åˆ‡æ¢åˆ° user-service SSO é¡µé¢ã€‚
- AI èƒ½åŠ›æ‰©å±•ï¼šæ–°å¢ Embeddings/OCR ä»£ç† + Chat SSE æµå¼è¾“å‡ºã€‚
- ç§¯åˆ†ä½“ç³»å®Œå–„ï¼šç­¾åˆ°ã€æ¶ˆè´¹è®°å½•ã€è´¦æœ¬ã€å…‘æ¢ç ï¼Œé›†æˆåˆ°ä¸ªäººä¸­å¿ƒã€‚
- ä¿æŒ BFF æ¶æ„ä¸å˜ï¼šå‰ç«¯ä»é€šè¿‡ HTTP è°ƒç”¨åç«¯ï¼Œåç«¯å°è£… gRPC ç»†èŠ‚ã€‚

## 2. æ€»ä½“æ¶æ„å˜æ›´

```text
v1.1 æ¶æ„ï¼ˆä¿æŒä¸å˜ï¼‰ï¼š
Frontend â”€â”€HTTPâ”€â”€> Backend(BFF) â”€â”€gRPCâ”€â”€> user/pay/ai-service

v1.2 æ–°å¢é“¾è·¯ï¼š
Frontend â”€â”€window.locationâ”€â”€> user-service SSO é¡µé¢
         <â”€â”€302 redirectâ”€â”€â”€â”€ user-serviceï¼ˆæºå¸¦ fragmentï¼‰
Frontend â”€â”€HTTPâ”€â”€> Backend /api/auth/sso-callbackï¼ˆå»ºç«‹æœ¬åœ°ä¼šè¯ï¼‰
Frontend â”€â”€SSEâ”€â”€> Backend /api/ai/chat/streamï¼ˆæµå¼ AI å“åº”ï¼‰
Backend  â”€â”€HTTPâ”€â”€> Consulï¼ˆæŸ¥è¯¢ user-service HTTP åœ°å€ï¼‰
```

å…³é”®å˜æ›´ç‚¹ï¼š
- æ–°å¢ Consul HTTP æŸ¥è¯¢èƒ½åŠ›ï¼ˆåŒºåˆ«äº gRPC æœåŠ¡å‘ç°ï¼‰
- å‰ç«¯ç›´æ¥è·³è½¬ user-service SSO é¡µé¢ï¼ˆæµè§ˆå™¨å¯ç›´è¾¾ï¼‰
- æ–°å¢ SSE ç«¯ç‚¹ç”¨äº AI æµå¼è¾“å‡º

---

## 3. åç«¯è®¾è®¡

### 3.1 Consul HTTP æœåŠ¡å‘ç°

**æ–°å¢ç±»ï¼š** `integration/consul/ConsulHttpServiceDiscovery.java`

```java
@Component
public class ConsulHttpServiceDiscovery {
    private final String consulAddr; // ä»ç¯å¢ƒå˜é‡ CONSUL_HTTP_ADDR è·å–

    /**
     * æŸ¥è¯¢ Consul ä¸­æŒ‡å®šæœåŠ¡çš„å¥åº·å®ä¾‹åœ°å€
     * GET /v1/health/service/{serviceName}?passing=true
     * è¿”å› http://{address}:{port}
     */
    public String resolveHttpAddress(String serviceName) { ... }
}
```

ç”¨é€”ï¼šä¸º SSO è·³è½¬æä¾› user-service çš„ HTTP åŸºåœ°å€ã€‚ä¸ gRPC çš„ `ConsulNameResolverProvider` ç‹¬ç«‹ï¼Œå› ä¸ºï¼š
- gRPC å‘ç°è¿”å›çš„æ˜¯ gRPC ç«¯å£ï¼ŒSSO éœ€è¦ HTTP ç«¯å£
- Consul ä¸­ HTTP æœåŠ¡åä¸º `aienie-userservice-http`ï¼Œä¸ gRPC æœåŠ¡å `aienie-userservice-grpc` ä¸åŒ

**é…ç½®ï¼š**
```yaml
# application.yml
app:
  consul:
    address: ${CONSUL_HTTP_ADDR:192.168.1.4:60000}
  sso:
    user-service-name: aienie-userservice-http  # Consul ä¸­çš„ HTTP æœåŠ¡å
    callback-url: ${SSO_CALLBACK_URL:http://localhost:5173/sso/callback}  # å‰ç«¯å›è°ƒåœ°å€
```

### 3.2 SSO è®¤è¯æ”¹é€ 

#### 3.2.1 ç§»é™¤çš„æ¥å£

- ~~`POST /api/auth/register`~~ â€” æ³¨å†Œç”± SSO é¡µé¢å®Œæˆ
- ~~`POST /api/auth/login`~~ â€” ç™»å½•ç”± SSO é¡µé¢å®Œæˆ

#### 3.2.2 æ–°å¢æ¥å£

**`GET /api/auth/sso-url`**

è¿”å› SSO ç™»å½•å’Œæ³¨å†Œé¡µé¢çš„å®Œæ•´ URLï¼Œå‰ç«¯æ‹¿åˆ°å `window.location.href` è·³è½¬ã€‚

```
è¯·æ±‚ï¼šGET /api/auth/sso-url?type=login|register
å“åº”ï¼š
{
  "loginUrl": "http://<user-service-addr>/sso/login?redirect=<callback-url>",
  "registerUrl": "http://<user-service-addr>/register?redirect=<callback-url>"
}
```

å®ç°é€»è¾‘ï¼š
1. è°ƒç”¨ `ConsulHttpServiceDiscovery.resolveHttpAddress("aienie-userservice-http")` è·å–åŸºåœ°å€
2. æ‹¼æ¥ SSO è·¯å¾„å’Œ `redirect` å‚æ•°ï¼ˆå€¼ä¸ºé…ç½®çš„ `sso.callback-url`ï¼‰
3. å¯ç¼“å­˜åŸºåœ°å€ï¼ˆTTL 30sï¼‰ï¼Œé¿å…æ¯æ¬¡æŸ¥è¯¢ Consul

**`POST /api/auth/sso-callback`**

æ¥æ”¶å‰ç«¯ä» SSO å›è°ƒä¸­è§£æå‡ºçš„è®¤è¯æ•°æ®ï¼Œå»ºç«‹æœ¬åœ°ä¼šè¯ã€‚

```
è¯·æ±‚ï¼šPOST /api/auth/sso-callback
{
  "accessToken": "xxx",
  "userId": 1001,
  "username": "demo_user",
  "sessionId": "sess-xxx"
}
å“åº”ï¼š
{
  "token": "<local-token>",
  "user": { ... AuthUserView ... }
}
```

å®ç°é€»è¾‘ï¼š
1. è°ƒç”¨ `UserGrpcClient.validateSession(userId, sessionId)` éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
2. éªŒè¯é€šè¿‡åï¼Œupsert æœ¬åœ° User è®°å½•ï¼ˆå¤ç”¨ç°æœ‰ `upsertLocalUser` é€»è¾‘ï¼‰
3. å­˜å‚¨ `accessToken` å’Œ `sessionId` åˆ°æœ¬åœ° User
4. ç­¾å‘æœ¬åœ° tokenï¼ˆå¤ç”¨ç°æœ‰ `issueToken` é€»è¾‘ï¼‰
5. è¿”å› AuthResponse

**`GET /api/auth/me`** â€” ä¿æŒä¸å˜

#### 3.2.3 AuthService æ”¹é€ 

```java
// ç§»é™¤
- public AuthResponse register(...)
- public AuthResponse login(...)
- private String resolveLoginUsername(...)
- private String resolveRegisterUsername(...)
- private String normalizeEmail(...)

// æ–°å¢
+ public AuthResponse ssoCallback(long userId, String username,
+                                  String sessionId, String accessToken)

// ä¿ç•™
  public User authenticate(String token)  // ä¸å˜
  public AuthUserView currentUserView(String token)  // ä¸å˜
```

`ssoCallback` å®ç°ï¼š
1. `validateSession(userId, sessionId)` â†’ è·å– `ExternalUserProfile`
2. `upsertLocalUser(profile, sessionId, accessToken)`
3. `issueToken(localUser)`
4. `buildUserView(localUser)` â†’ è¿”å› `AuthResponse`

### 3.3 AI èƒ½åŠ›æ‰©å±•

#### 3.3.1 æ–°å¢ Embeddings æ¥å£

**`POST /api/ai/embeddings`**ï¼ˆéœ€è®¤è¯ï¼‰

```
è¯·æ±‚ï¼š
{
  "input": ["æ–‡æœ¬A", "æ–‡æœ¬B"],
  "model": "text-embedding-xxx",  // å¯é€‰ï¼Œç©ºåˆ™èµ°é»˜è®¤
  "normalize": true               // å¯é€‰ï¼Œé»˜è®¤ true
}
å“åº”ï¼š
{
  "modelKey": "text-embedding-xxx",
  "dimensions": 1536,
  "embeddings": [[0.1, 0.2, ...], [0.3, 0.4, ...]],
  "promptTokens": 24
}
```

åç«¯å®ç°ï¼š
- `AiProxyService.embeddings(request, user)` â†’ `AiGrpcClient.embeddings(...)`
- ä¼ å…¥ `projectKey`, `userId`, `sessionId`, `model`, `input[]`, `normalize`

#### 3.3.2 æ–°å¢ OCR æ¥å£

**`POST /api/ai/ocr`**ï¼ˆéœ€è®¤è¯ï¼‰

```
è¯·æ±‚ï¼š
{
  "imageUrl": "https://...",       // ä¸‰é€‰ä¸€
  "imageBase64": "base64...",      // ä¸‰é€‰ä¸€
  "documentUrl": "https://...",    // ä¸‰é€‰ä¸€
  "model": "",                     // å¯é€‰
  "pages": "1-5",                  // å¯é€‰ï¼ŒPDF é¡µç èŒƒå›´
  "outputType": "TEXT"             // TEXT | MARKDOWN | JSON
}
å“åº”ï¼š
{
  "modelKey": "ocr-model",
  "outputType": "TEXT",
  "content": "è§£æå‡ºçš„æ–‡æœ¬å†…å®¹...",
  "rawJson": "{...}"              // outputType=JSON æ—¶æœ‰å€¼
}
```

åç«¯å®ç°ï¼š
- `AiProxyService.ocrParse(request, user)` â†’ `AiGrpcClient.ocrParse(...)`
- ä¼ å…¥ `projectKey`, `userId`, `sessionId`, `model`, å›¾ç‰‡/æ–‡æ¡£å‚æ•°, `outputType`

#### 3.3.3 Chat SSE æµå¼è¾“å‡º

**`POST /api/ai/chat/stream`**ï¼ˆéœ€è®¤è¯ï¼‰

```
è¯·æ±‚ï¼ˆä¸ /api/ai/chat ç›¸åŒï¼‰ï¼š
{
  "messages": [{"role": "user", "content": "ä½ å¥½"}],
  "model": ""
}
å“åº”ï¼šContent-Type: text/event-stream

data: {"content":"ä½ ","done":false}
data: {"content":"å¥½","done":false}
data: {"content":"ï¼","done":false}
data: {"content":"","done":true,"modelKey":"gpt-4o-mini","promptTokens":10,"completionTokens":5}
```

åç«¯å®ç°æ–¹æ¡ˆï¼ˆgRPC Unary â†’ SSE æ¨¡æ‹Ÿåˆ†å—ï¼‰ï¼š

```java
@PostMapping(value = "/chat/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public SseEmitter chatStream(@RequestBody AiChatRequest request,
                              @RequestHeader("X-Auth-Token") String token) {
    SseEmitter emitter = new SseEmitter(60_000L);
    User user = authService.authenticate(token);

    CompletableFuture.runAsync(() -> {
        try {
            // 1. gRPC Unary è°ƒç”¨è·å–å®Œæ•´å“åº”
            AiChatResult result = aiProxyService.chat(request, user);

            // 2. å°† content æŒ‰å­—ç¬¦åˆ†å—æ¨é€
            String content = result.content();
            int chunkSize = 2; // æ¯æ¬¡æ¨é€ 2 ä¸ªå­—ç¬¦
            for (int i = 0; i < content.length(); i += chunkSize) {
                String chunk = content.substring(i, Math.min(i + chunkSize, content.length()));
                emitter.send(SseEmitter.event()
                    .data(Map.of("content", chunk, "done", false)));
                Thread.sleep(30); // æ¨¡æ‹Ÿæ‰“å­—æ•ˆæœ
            }

            // 3. å‘é€å®Œæˆäº‹ä»¶ï¼ˆå« token ç»Ÿè®¡ï¼‰
            emitter.send(SseEmitter.event()
                .data(Map.of("content", "", "done", true,
                    "modelKey", result.modelKey(),
                    "promptTokens", result.promptTokens(),
                    "completionTokens", result.completionTokens())));
            emitter.complete();
        } catch (Exception e) {
            emitter.completeWithError(e);
        }
    });

    return emitter;
}
```

æ³¨æ„äº‹é¡¹ï¼š
- å½“å‰ ai-service çš„ `ChatCompletions` æ˜¯ Unary RPCï¼Œæµå¼æ•ˆæœä¸ºåç«¯æ¨¡æ‹Ÿ
- åç»­ ai-service æ”¯æŒ Server Streaming åï¼Œå¯æ”¹ä¸ºçœŸæ­£çš„æµå¼è½¬å‘ï¼Œæ¥å£åè®®ä¸å˜
- `SseEmitter` è¶…æ—¶è®¾ä¸º 60sï¼Œè¦†ç›–å¤§éƒ¨åˆ† AI å“åº”åœºæ™¯
- éœ€è¦åœ¨ Spring é…ç½®ä¸­å¯ç”¨å¼‚æ­¥æ”¯æŒï¼ˆ`@EnableAsync`ï¼‰

#### 3.3.4 AiGrpcClient æ–°å¢æ–¹æ³•

```java
// æ–°å¢
+ AiEmbeddingsResult embeddings(String projectKey, long userId,
+     String sessionId, String model, List<String> input, boolean normalize)
+ AiOcrResult ocrParse(String projectKey, long userId,
+     String sessionId, String model, AiOcrParams params)
```

#### 3.3.5 æ–°å¢ DTO

```java
// è¯·æ±‚
record AiEmbeddingsRequest(List<String> input, String model, Boolean normalize)
record AiOcrRequest(String imageUrl, String imageBase64, String documentUrl,
                    String model, String pages, String outputType)

// å“åº”ï¼ˆgRPC æ˜ å°„ï¼‰
record AiEmbeddingsResult(String modelKey, int dimensions,
                          List<List<Float>> embeddings, long promptTokens)
record AiOcrResult(String requestId, String modelKey, String outputType,
                   String content, String rawJson)
```

### 3.4 ç§¯åˆ†ä½“ç³»å®Œå–„

#### 3.4.1 BillingGrpcClient æ–°å¢æ–¹æ³•

```java
// ç­¾åˆ°
+ CheckinResult checkin(String projectKey, long userId)
+ CheckinStatusResult getCheckinStatus(String projectKey, long userId)

// æ¶ˆè´¹è®°å½•
+ PagedResult<UsageRecord> listUsageRecords(String projectKey, long userId, int page, int size)
+ PagedResult<LedgerEntry> listLedgerEntries(String projectKey, long userId, int page, int size)

// å…‘æ¢ç 
+ RedeemResult redeemCode(String projectKey, long userId, String code)
+ PagedResult<RedemptionRecord> getRedemptionHistory(String projectKey, long userId, int page, int size)
```

#### 3.4.2 æ–°å¢ WalletService

```java
@Service
public class WalletService {
    private final BillingGrpcClient billingGrpcClient;
    private final BalanceService balanceService;
    private final AppProperties appProperties;

    // ç­¾åˆ°
    public CheckinResult checkin(User user) { ... }
    public CheckinStatusResult getCheckinStatus(User user) { ... }

    // ä½™é¢ï¼ˆå¤ç”¨ BalanceServiceï¼‰
    public BalanceSnapshot getBalance(User user) { ... }

    // æ¶ˆè´¹è®°å½•
    public PagedResult<UsageRecord> getUsageRecords(User user, int page, int size) { ... }
    public PagedResult<LedgerEntry> getLedgerEntries(User user, int page, int size) { ... }

    // å…‘æ¢ç 
    public RedeemResult redeemCode(User user, String code) { ... }
    public PagedResult<RedemptionRecord> getRedemptionHistory(User user, int page, int size) { ... }
}
```

æ‰€æœ‰å†™æ“ä½œï¼ˆcheckinã€redeemCodeï¼‰å¿…é¡»ç”Ÿæˆç¨³å®šå”¯ä¸€çš„ `request_id`ï¼Œæ ¼å¼å»ºè®®ï¼š
`aisocialgame:{operation}:{userId}:{date|uuid}`

#### 3.4.3 æ–°å¢ WalletController

```java
@RestController
@RequestMapping("/api/wallet")
public class WalletController {

    @PostMapping("/checkin")
    public CheckinResponse checkin(@RequestHeader("X-Auth-Token") String token)

    @GetMapping("/checkin-status")
    public CheckinStatusResponse getCheckinStatus(@RequestHeader("X-Auth-Token") String token)

    @GetMapping("/balance")
    public BalanceResponse getBalance(@RequestHeader("X-Auth-Token") String token)

    @GetMapping("/usage-records")
    public PagedResponse<UsageRecordView> getUsageRecords(
        @RequestHeader("X-Auth-Token") String token,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "20") int size)

    @GetMapping("/ledger")
    public PagedResponse<LedgerEntryView> getLedgerEntries(
        @RequestHeader("X-Auth-Token") String token,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "20") int size)

    @PostMapping("/redeem")
    public RedeemResponse redeemCode(
        @RequestHeader("X-Auth-Token") String token,
        @RequestBody RedeemRequest request)

    @GetMapping("/redemption-history")
    public PagedResponse<RedemptionView> getRedemptionHistory(
        @RequestHeader("X-Auth-Token") String token,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "20") int size)
}
```

#### 3.4.4 æ–°å¢ DTO

```java
// ç­¾åˆ°
record CheckinResponse(boolean success, long tokensGranted,
                       boolean alreadyCheckedIn, BalanceSnapshot balance)
record CheckinStatusResponse(boolean checkedInToday, String lastCheckinDate,
                             long tokensGrantedToday)

// æ¶ˆè´¹è®°å½•ï¼ˆä» gRPC UsageRecord æ˜ å°„ï¼‰
record UsageRecordView(String requestId, String modelKey,
                       long promptTokens, long completionTokens,
                       long billedTokens, String sessionId,
                       String createdAt)

// è´¦æœ¬ï¼ˆä» gRPC LedgerEntry æ˜ å°„ï¼‰
record LedgerEntryView(String id, String type, long tokens,
                       String reason, String createdAt)

// å…‘æ¢ç 
record RedeemRequest(String code)
record RedeemResponse(boolean success, long tokensGranted,
                      String creditType, String errorMessage,
                      BalanceSnapshot balance)

// å…‘æ¢å†å²
record RedemptionView(String code, long tokensGranted,
                      String creditType, String redeemedAt)

// é€šç”¨åˆ†é¡µ
record PagedResponse<T>(List<T> items, int page, int size, long total)
```

---

## 4. å‰ç«¯è®¾è®¡

### 4.1 SSO ç™»å½•æµç¨‹æ”¹é€ 

#### 4.1.1 åˆ é™¤çš„æ–‡ä»¶

- `pages/Login.tsx`
- `pages/Register.tsx`

#### 4.1.2 æ–°å¢ SsoCallback é¡µé¢

**è·¯ç”±ï¼š** `/sso/callback`

**èŒè´£ï¼š** è§£æ user-service SSO å›è·³æ—¶ URL fragment ä¸­çš„è®¤è¯æ•°æ®ï¼Œè°ƒç”¨åç«¯å»ºç«‹æœ¬åœ°ä¼šè¯ã€‚

```tsx
// pages/SsoCallback.tsx
const SsoCallback = () => {
  useEffect(() => {
    // 1. ä» URL fragment è§£æå‚æ•°
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const accessToken = params.get("access_token");
    const userId = params.get("user_id");
    const username = params.get("username");
    const sessionId = params.get("session_id");

    // 2. è°ƒç”¨åç«¯ sso-callback æ¥å£
    authApi.ssoCallback({ accessToken, userId, username, sessionId })
      .then(res => {
        // 3. ä¿å­˜ tokenï¼Œæ›´æ–°ç”¨æˆ·çŠ¶æ€
        localStorage.setItem(LOCAL_TOKEN_KEY, res.token);
        setToken(res.token);
        setUser(res.user);
        navigate("/");
      })
      .catch(() => {
        toast.error("ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•");
        navigate("/");
      });
  }, []);

  return <LoadingSpinner text="æ­£åœ¨ç™»å½•..." />;
};
```

#### 4.1.3 useAuth æ”¹é€ 

```tsx
// ç§»é™¤
- login(account, password)
- register(username, email, password, nickname)

// æ–°å¢
+ redirectToSsoLogin()   // è·å– SSO URL åè·³è½¬
+ redirectToSsoRegister() // è·å– SSO URL åè·³è½¬
+ ssoCallback(data)       // SSO å›è°ƒå¤„ç†

// ä¿ç•™
  logout()
  user / token / loading / displayName / avatar
```

`redirectToSsoLogin` å®ç°ï¼š
```tsx
const redirectToSsoLogin = async () => {
  const { loginUrl } = await authApi.getSsoUrl();
  window.location.href = loginUrl;
};
```

#### 4.1.4 è·¯ç”±å˜æ›´

```tsx
// App.tsx
// ç§»é™¤
- <Route path="/login" element={<Login />} />
- <Route path="/register" element={<Register />} />

// æ–°å¢
+ <Route path="/sso/callback" element={<SsoCallback />} />
```

æ‰€æœ‰åŸæ¥è·³è½¬ `/login` çš„åœ°æ–¹æ”¹ä¸ºè°ƒç”¨ `redirectToSsoLogin()`ï¼š
- MainLayout çš„ã€Œç™»å½•ã€æŒ‰é’®
- Profile é¡µé¢çš„ã€Œå‰å¾€ç™»å½•ã€æŒ‰é’®
- å…¶ä»–éœ€è¦ç™»å½•çš„å…¥å£

#### 4.1.5 api.ts å˜æ›´

```tsx
export const authApi = {
  // ç§»é™¤
  - async login(account, password)
  - async register(payload)

  // æ–°å¢
  + async getSsoUrl(): Promise<{ loginUrl: string; registerUrl: string }>
  + async ssoCallback(data: SsoCallbackData): Promise<AuthResponse>

  // ä¿ç•™
  async me(): Promise<User>
};
```

### 4.2 AI æµå¼èŠå¤©

#### 4.2.1 aiApi æ–°å¢æ–¹æ³•

```tsx
export const aiApi = {
  // ä¿ç•™
  async listModels(): Promise<AiModel[]>,
  async chat(messages, model?): Promise<AiChatResponse>,

  // æ–°å¢
  async chatStream(messages: AiMessage[], model?: string,
                   onChunk: (chunk: string) => void,
                   onDone: (result: AiChatResponse) => void): Promise<void>,
  async embeddings(input: string[], model?: string, normalize?: boolean): Promise<AiEmbeddingsResponse>,
  async ocr(params: AiOcrParams): Promise<AiOcrResponse>,
};
```

`chatStream` å®ç°ï¼š
```tsx
async chatStream(messages, model, onChunk, onDone) {
  const response = await fetch("/api/ai/chat/stream", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Auth-Token": getToken(),
    },
    body: JSON.stringify({ messages, model }),
  });

  const reader = response.body!.getReader();
  const decoder = new TextDecoder();

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    const text = decoder.decode(value);
    // è§£æ SSE data è¡Œ
    for (const line of text.split("\n")) {
      if (!line.startsWith("data:")) continue;
      const data = JSON.parse(line.slice(5));
      if (data.done) {
        onDone(data);
      } else {
        onChunk(data.content);
      }
    }
  }
}
```

### 4.3 ä¸ªäººä¸­å¿ƒ â€” é’±åŒ…å­é¡µé¢

#### 4.3.1 Profile é¡µé¢æ”¹é€ 

åœ¨ç°æœ‰ Profile é¡µé¢çš„ Tabs ä¸­æ–°å¢ã€Œæˆ‘çš„é’±åŒ…ã€Tabï¼Œæˆ–å°†ç°æœ‰ã€Œæˆ‘çš„èµ„äº§ã€Tab å‡çº§ä¸ºå®Œæ•´é’±åŒ…åŠŸèƒ½ã€‚

```tsx
// Profile.tsx Tabs ç»“æ„
<Tabs defaultValue="wallet">
  <TabsList>
    <TabsTrigger value="wallet">æˆ‘çš„é’±åŒ…</TabsTrigger>
    <TabsTrigger value="history">å¯¹æˆ˜è®°å½•</TabsTrigger>
    <TabsTrigger value="stats">æ•°æ®ç»Ÿè®¡</TabsTrigger>
  </TabsList>

  <TabsContent value="wallet">
    <WalletPanel />
  </TabsContent>
  ...
</Tabs>
```

#### 4.3.2 WalletPanel ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’° ä½™é¢æ¦‚è§ˆ                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æ€»ç§¯åˆ†    â”‚ â”‚ é¡¹ç›®æ°¸ä¹…  â”‚ â”‚ é¡¹ç›®ä¸´æ—¶  â”‚     â”‚
â”‚  â”‚ 12,500   â”‚ â”‚ 10,000   â”‚ â”‚ 2,500    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚  ğŸ“… æ¯æ—¥ç­¾åˆ°                    [ç­¾åˆ°é¢†ç§¯åˆ†]   â”‚
â”‚  ä»Šæ—¥å·²ç­¾åˆ° âœ“  è·å¾— 100 ç§¯åˆ†                   â”‚
â”‚                                              â”‚
â”‚  ğŸ« å…‘æ¢ç                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” [å…‘æ¢]              â”‚
â”‚  â”‚ è¯·è¾“å…¥å…‘æ¢ç ...       â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                              â”‚
â”‚  ğŸ“Š æ¶ˆè´¹è®°å½•                    [æŸ¥çœ‹å…¨éƒ¨ >]   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ gpt-4o-mini  -150 tokens  2024-01-15 â”‚   â”‚
â”‚  â”‚ gpt-4o       -320 tokens  2024-01-14 â”‚   â”‚
â”‚  â”‚ ...                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç»„ä»¶æ‹†åˆ†ï¼š
- `WalletPanel.tsx` â€” é’±åŒ…ä¸»é¢æ¿ï¼Œç»„åˆä»¥ä¸‹å­ç»„ä»¶
- `BalanceOverview.tsx` â€” ä½™é¢æ¦‚è§ˆå¡ç‰‡
- `CheckinCard.tsx` â€” ç­¾åˆ°å¡ç‰‡ï¼ˆå«ç­¾åˆ°æŒ‰é’®å’ŒçŠ¶æ€ï¼‰
- `RedeemCard.tsx` â€” å…‘æ¢ç è¾“å…¥å¡ç‰‡
- `UsageRecordList.tsx` â€” æ¶ˆè´¹è®°å½•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰

#### 4.3.3 walletApi

```tsx
export const walletApi = {
  async checkin(): Promise<CheckinResponse>,
  async getCheckinStatus(): Promise<CheckinStatusResponse>,
  async getBalance(): Promise<BalanceResponse>,
  async getUsageRecords(page?: number, size?: number): Promise<PagedResponse<UsageRecord>>,
  async getLedger(page?: number, size?: number): Promise<PagedResponse<LedgerEntry>>,
  async redeemCode(code: string): Promise<RedeemResponse>,
  async getRedemptionHistory(page?: number, size?: number): Promise<PagedResponse<RedemptionRecord>>,
};
```

#### 4.3.4 ç§¯åˆ†å…¥å£

- å¤´éƒ¨å¯¼èˆªæ çš„ç§¯åˆ†æ•°å­—ï¼ˆ`MainLayout.tsx` ä¸­çš„ Coins å±•ç¤ºï¼‰ç‚¹å‡»åè·³è½¬åˆ° `/profile?tab=wallet`
- ä¸ªäººä¸­å¿ƒé»˜è®¤å±•ç¤ºé’±åŒ… Tab

### 4.4 ç±»å‹å®šä¹‰æ–°å¢

```tsx
// types/index.ts æ–°å¢

export interface SsoCallbackData {
  accessToken: string;
  userId: number;
  username: string;
  sessionId: string;
}

export interface CheckinResponse {
  success: boolean;
  tokensGranted: number;
  alreadyCheckedIn: boolean;
  balance: BalanceInfo;
}

export interface CheckinStatusResponse {
  checkedInToday: boolean;
  lastCheckinDate: string;
  tokensGrantedToday: number;
}

export interface BalanceInfo {
  publicPermanentTokens: number;
  projectTempTokens: number;
  projectPermanentTokens: number;
  totalTokens: number;
  projectTempExpiresAt?: string;
}

export interface UsageRecord {
  requestId: string;
  modelKey: string;
  promptTokens: number;
  completionTokens: number;
  billedTokens: number;
  sessionId: string;
  createdAt: string;
}

export interface LedgerEntry {
  id: string;
  type: string;
  tokens: number;
  reason: string;
  createdAt: string;
}

export interface RedeemResponse {
  success: boolean;
  tokensGranted: number;
  creditType: string;
  errorMessage?: string;
  balance: BalanceInfo;
}

export interface RedemptionRecord {
  code: string;
  tokensGranted: number;
  creditType: string;
  redeemedAt: string;
}

export interface AiEmbeddingsResponse {
  modelKey: string;
  dimensions: number;
  embeddings: number[][];
  promptTokens: number;
}

export interface AiOcrParams {
  imageUrl?: string;
  imageBase64?: string;
  documentUrl?: string;
  model?: string;
  pages?: string;
  outputType?: string;
}

export interface AiOcrResponse {
  modelKey: string;
  outputType: string;
  content: string;
  rawJson?: string;
}

export interface PagedResponse<T> {
  items: T[];
  page: number;
  size: number;
  total: number;
}
```

---

## 5. é…ç½®å˜æ›´

### 5.1 application.yml æ–°å¢

```yaml
app:
  consul:
    address: ${CONSUL_HTTP_ADDR:192.168.1.4:60000}
  sso:
    user-service-name: ${SSO_USER_SERVICE_NAME:aienie-userservice-http}
    callback-url: ${SSO_CALLBACK_URL:http://localhost:5173/sso/callback}
```

### 5.2 å‰ç«¯ç¯å¢ƒå˜é‡

æ— æ–°å¢ã€‚SSO URL ç”±åç«¯åŠ¨æ€æä¾›ï¼Œå‰ç«¯ä¸éœ€è¦é…ç½® user-service åœ°å€ã€‚

### 5.3 docker-compose.yml æ–°å¢ç¯å¢ƒå˜é‡

```yaml
backend:
  environment:
    - CONSUL_HTTP_ADDR=${CONSUL_HTTP_ADDR}
    - SSO_CALLBACK_URL=${SSO_CALLBACK_URL:-http://aisocialgame.local/sso/callback}
```

---

## 6. v1.1 å·²å®ç°åŠŸèƒ½è¯„ä¼°

| åŠŸèƒ½ | v1.1 çŠ¶æ€ | v1.2 è°ƒæ•´ |
|---|---|---|
| gRPC åŸºç¡€è®¾æ–½ | âœ… å®Œæˆ | ä¿æŒä¸å˜ |
| æœ¬åœ°ç™»å½•/æ³¨å†Œ â†’ user-service | âœ… å®Œæˆ | ç§»é™¤ï¼Œæ”¹ä¸º SSO |
| ä½™é¢èšåˆå±•ç¤º | âœ… å®Œæˆ | ä¿æŒï¼Œæ–°å¢ç‹¬ç«‹é’±åŒ…é¡µé¢ |
| AI Chat/Models ä»£ç† | âœ… å®Œæˆ | ä¿æŒï¼Œæ–°å¢ SSE/Embeddings/OCR |
| ç®¡ç†åå° | âœ… å®Œæˆ | ä¿æŒä¸å˜ |
| Consul gRPC å‘ç° | âœ… å®Œæˆ | ä¿æŒï¼Œæ–°å¢ HTTP å‘ç° |

è¯„ä¼°ç»“è®ºï¼šv1.1 çš„å®ç°è´¨é‡è‰¯å¥½ï¼Œv1.2 åœ¨å…¶åŸºç¡€ä¸Šåšå¢é‡æ‰©å±•ï¼Œä¸éœ€è¦å¯¹å·²æœ‰ä»£ç åšå¤§è§„æ¨¡é‡æ„ã€‚ä¸»è¦å˜æ›´é›†ä¸­åœ¨ï¼š
1. AuthService/AuthController ç§»é™¤ login/registerï¼Œæ–°å¢ ssoCallback
2. AiProxyService/AiController æ–°å¢ embeddings/ocr/chatStream
3. æ–°å¢ WalletService/WalletController æ•´å¥—ç§¯åˆ†ç®¡ç†
4. å‰ç«¯ç™»å½•æµç¨‹é‡å†™ï¼Œæ–°å¢é’±åŒ…ç»„ä»¶

---

## 7. æµ‹è¯•è®¾è®¡

### 7.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•ç±» | è¦†ç›–ç‚¹ |
|---|---|
| `AuthServiceTest` | ssoCallback æˆåŠŸ/ä¼šè¯æ— æ•ˆ/ç”¨æˆ·ä¸å­˜åœ¨ |
| `WalletServiceTest` | ç­¾åˆ°æˆåŠŸ/é‡å¤ç­¾åˆ°/å…‘æ¢æˆåŠŸ/å…‘æ¢å¤±è´¥/æ¶ˆè´¹è®°å½•åˆ†é¡µ |
| `AiProxyServiceTest` | embeddings è¯·æ±‚æ˜ å°„/ocr è¯·æ±‚æ˜ å°„/å¼‚å¸¸åˆ†æ”¯ |
| `ConsulHttpServiceDiscoveryTest` | æ­£å¸¸è§£æ/æ— å¥åº·å®ä¾‹/Consul ä¸å¯è¾¾ |

### 7.2 E2Eï¼ˆPlaywrightï¼‰

| åœºæ™¯ | æ­¥éª¤ |
|---|---|
| SSO ç™»å½• | ç‚¹å‡»ç™»å½• â†’ è·³è½¬ SSO â†’ å®Œæˆç™»å½• â†’ å›è°ƒ â†’ è¿›å…¥é¦–é¡µ |
| ç­¾åˆ° | ç™»å½• â†’ è¿›å…¥ä¸ªäººä¸­å¿ƒ â†’ é’±åŒ… â†’ ç‚¹å‡»ç­¾åˆ° â†’ ç§¯åˆ†å¢åŠ  |
| æ¶ˆè´¹è®°å½• | ç™»å½• â†’ é’±åŒ… â†’ æŸ¥çœ‹æ¶ˆè´¹è®°å½•åˆ—è¡¨ â†’ ç¿»é¡µ |
| å…‘æ¢ç  | ç™»å½• â†’ é’±åŒ… â†’ è¾“å…¥å…‘æ¢ç  â†’ å…‘æ¢æˆåŠŸ â†’ ç§¯åˆ†å¢åŠ  |
| AI æµå¼èŠå¤© | ç™»å½• â†’ AI èŠå¤© â†’ å‘é€æ¶ˆæ¯ â†’ é€å­—æ˜¾ç¤ºå“åº” |

---

## 8. å®æ–½é¡ºåºå»ºè®®

1. **Consul HTTP å‘ç° + SSO åç«¯æ¥å£** â€” åŸºç¡€è®¾æ–½ï¼Œå…¶ä»–åŠŸèƒ½ä¾èµ–
2. **å‰ç«¯ SSO æµç¨‹æ”¹é€ ** â€” ç™»å½•æ³¨å†Œå…¨é¢åˆ‡æ¢
3. **ç§¯åˆ†åç«¯æ¥å£ï¼ˆWalletService/Controllerï¼‰** â€” ç­¾åˆ°ã€è®°å½•ã€å…‘æ¢ç 
4. **å‰ç«¯é’±åŒ…é¡µé¢** â€” ä¸ªäººä¸­å¿ƒå­é¡µé¢
5. **AI æ–°æ¥å£ï¼ˆEmbeddings/OCRï¼‰** â€” åç«¯ä»£ç†
6. **AI SSE æµå¼è¾“å‡º** â€” åç«¯ + å‰ç«¯
7. **æµ‹è¯•ä¸æ–‡æ¡£æ”¶å°¾**
